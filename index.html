<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catatan Pengantaran Andaria</title>
<!-- Google Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* CSS Variables for Light and Dark themes */
  :root {
    --bg-color: #f9fafe;
    --text-color: #222;
    --card-bg: #fff;
    --input-bg: #fff;
    --input-border: #ddd;
    --primary-color: #4f46e5;
    --primary-hover: #3730a3;
    --secondary-color: #2563eb;
    --success-color: #047857;
    --success-icon: #059669;
    --shadow-color: rgba(0,0,0,0.05);
    --btn-shadow: rgba(79, 70, 229, 0.25);
  }
  body.dark {
    --bg-color: #121214;
    --text-color: #eee;
    --card-bg: #1e1e2f;
    --input-bg: #2a2a43;
    --input-border: #444;
    --primary-color: #818cf8;
    --primary-hover: #4c51bf;
    --secondary-color: #3b82f6;
    --success-color: #34d399;
    --success-icon: #10b981;
    --shadow-color: rgba(255,255,255,0.1);
    --btn-shadow: rgba(129,140,248,0.4);
  }

  /* Reset and base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    line-height: 1.4;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
    transition: background-color 0.4s ease, color 0.4s ease;
    perspective: 1px; /* For parallax */
    overflow-x: hidden;
  }
  h1 {
    font-weight: 700;
    margin-bottom: 24px;
    font-size: 1.8rem;
    text-align: center;
  }
  /* Parallax background container */
  .parallax-bg {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/82fe17e9-749f-4352-85ed-9fa9439c50b1.png');
    background-size: cover;
    background-attachment: fixed;
    background-position: center;
    opacity: 0.15;
    z-index: -1;
    pointer-events: none;
  }
  body.dark .parallax-bg {
    background-image: url('https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/399e30ca-7b0c-438c-ac65-5903e4b136ff.png');
  }
  /* Container */
  .container {
    max-width: 960px;
    width: 100%;
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 12px 24px var(--shadow-color);
    padding: 24px 32px 32px;
    display: flex;
    flex-direction: column;
    gap: 32px;
    backdrop-filter: saturate(180%) blur(15px);
  }
  /* Inputs */
  input[type="text"],
  input[type="date"],
  input[type="number"],
  select,
  textarea {
    background: var(--input-bg);
    color: var(--text-color);
    border: 1.5px solid var(--input-border);
    width: 100%;
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 8px;
    transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    outline-offset: 2px;
  }
  input[type="text"]:focus,
  input[type="date"]:focus,
  select:focus,
  input[type="number"]:focus,
  textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 8px rgba(79, 70, 229, 0.3);
    background: var(--input-bg);
    color: var(--text-color);
  }
  label {
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
  }
  /* Checkbox container */
  .checkbox-group {
    align-self: center;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
  }
  input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  /* Button */
  button {
    grid-column: 1/-1;
    background: var(--primary-color);
    color: #fff;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 14px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
    box-shadow: 0 8px 15px var(--btn-shadow);
  }
  button:hover,
  button:focus {
    background-color: var(--primary-hover);
  }
  button:disabled {
    background-color: #a5b4fc;
    cursor: default;
    box-shadow: none;
  }
  /* Search section */
  .search-section {
    border-top: 2px solid var(--input-border);
    padding-top: 20px;
  }
  .search-form {
    display: flex;
    flex-wrap: wrap;
    gap: 16px 24px;
    justify-content: space-between;
    align-items: center;
  }
  .search-form > * {
    flex: 1 1 280px;
    min-width: 280px;
  }
  .search-form input,
  .search-form select {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1.5px solid var(--input-border);
    font-size: 1rem;
    outline-offset: 2px;
    transition: border-color 0.3s ease;
    width: 100%;
    background: var(--input-bg);
    color: var(--text-color);
  }
  .search-form input:focus,
  .search-form select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 8px rgba(79,70,229,0.3);
  }
  .search-button {
    flex: 0 0 140px;
    background: var(--secondary-color);
    color: #fff;
    font-weight: 600;
    font-size: 1rem;
    padding: 10px 0;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s ease;
    box-shadow: 0 5px 12px rgba(37, 99, 235, 0.3);
    align-self: center;
  }
  .search-button:hover,
  .search-button:focus {
    background-color: #1e40af;
  }
  /* Total cash sum container */
  .total-cash-container {
    background-color: var(--input-bg);
    border: 2px solid var(--primary-color);
    color: var(--primary-color);
    font-weight: 700;
    font-size: 1.3rem;
    padding: 14px 24px;
    border-radius: 12px;
    text-align: right;
    user-select: none;
    box-shadow: 0 4px 12px var(--shadow-color);
    margin: 12px 0 20px 0;
  }
  /* Results section */
  .results-section {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 8px;
    border-top: 1px solid var(--input-border);
    padding-top: 12px;
  }
  .result-item {
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 10px var(--shadow-color);
    padding: 16px 24px;
    margin-bottom: 16px;
    display: grid;
    grid-template-columns: 30px 1fr auto;
    gap: 8px 24px;
    align-items: start;
  }
  .result-left {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .result-item strong {
    font-weight: 700;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  /* Place selection checkbox inside the strong (left of name) */
  .result-item strong .select-checkbox {
    display: flex;
    align-items: center;
  }
  .select-checkbox {
    justify-content: center;
  }
  .select-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  /* Smaller info lines with no big breaks, keep inline */
  .result-left > div {
    margin: 0;
  }
  .result-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    color: var(--success-color);
    min-width: 140px;
    margin-top: 12px; /* move down */
  }
  .result-status label {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
  }
  .result-status .material-icons {
    font-size: 28px;
    color: var(--success-icon);
  }
  /* Cash deposit input style in results */
  .cash-deposit-input {
    width: 130px;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1.5px solid var(--input-border);
    font-size: 1rem;
    outline-offset: 2px;
    transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    text-align: right;
    background: var(--input-bg);
    color: var(--text-color);
  }
  .cash-deposit-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 8px rgba(79, 70, 229, 0.3);
  }
  /* Scrollbar styling */
  .results-section::-webkit-scrollbar {
    width: 8px;
  }
  .results-section::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 12px;
  }
  /* Responsive */
  @media (max-width: 600px) {
    form, .search-form {
      grid-template-columns: 1fr !important;
    }
    button, .search-button {
      width: 100%;
    }
    .result-status {
      flex-direction: row;
      justify-content: flex-start;
      margin-top: 8px;
    }
    .result-item {
      grid-template-columns: 30px 1fr auto;
      gap: 8px 16px;
    }
  }
  /* Accessibility: hide visually but keep for screen readers */
  .sr-only {
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
  }
  /* Dark mode toggle button style */
  .dark-mode-toggle {
    position: fixed;
    top: 12px;
    right: 12px;
    background: var(--card-bg);
    border: 1.5px solid var(--input-border);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    cursor: pointer;
    box-shadow: 0 3px 6px var(--shadow-color);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    z-index: 2000;
  }
  .dark-mode-toggle:hover,
  .dark-mode-toggle:focus {
    background: var(--primary-color);
    border-color: var(--primary-color);
  }
  .dark-mode-toggle .material-icons {
    font-size: 28px;
    color: var(--text-color);
  }
</style>
</head>
<body>
  <div class="parallax-bg" aria-hidden="true"></div>
  <button aria-label="Toggle mode gelap / terang" class="dark-mode-toggle" id="darkModeToggle" title="Toggle mode gelap / terang">
    <span class="material-icons" id="darkModeIcon">dark_mode</span>
  </button>
  <main class="container" role="main" aria-label="Catatan Pengantaran Andaria">
    <h1>Catatan Pengantaran Andaria</h1>

    <section aria-labelledby="input-header">
      <h2 id="input-header" style="font-size:1.25rem; margin-bottom:16px;">Input Data Pengantaran</h2>
      <form id="delivery-form" aria-describedby="form-desc" novalidate>
        <div>
          <label for="date-delivery">Tanggal Pengantaran</label>
          <input type="date" id="date-delivery" name="dateDelivery" required aria-required="true" aria-describedby="date-desc"/>
          <div id="date-desc" class="sr-only">Pilih tanggal pengantaran untuk menentukan hari, tanggal, bulan, dan tahun</div>
        </div>
        <div>
          <label for="day-delivery">Hari Pengantaran</label>
          <input type="text" id="day-delivery" name="dayDelivery" readonly aria-readonly="true" aria-describedby="day-desc"/>
          <div id="day-desc" class="sr-only">Hari otomatis disesuaikan dengan tanggal pengantaran</div>
        </div>
        <div>
          <label for="driver-name">Nama Supir</label>
          <input type="text" id="driver-name" name="driverName" required aria-required="true" autocomplete="off"/>
        </div>
        <div>
          <label for="plate-number">Nomor Plat Mobil</label>
          <input type="text" id="plate-number" name="plateNumber" placeholder="Isi hanya sekali per supir" autocomplete="off"/>
        </div>
        <div>
          <label for="route">Rute</label>
          <input type="text" id="route" name="route" required aria-required="true"/>
        </div>
        <div>
          <label for="division">Divisi Barang <small style="font-weight: normal; font-style: italic; color:#666;">(pisahkan dengan koma jika lebih dari satu)</small></label>
          <textarea id="division" name="division" rows="2" placeholder="Contoh: Elektronik, Makanan, Pakaian" required aria-required="true" style="resize: vertical;"></textarea>
        </div>
        <div>
          <label for="division-count">Jumlah Divisi</label>
          <input type="number" min="1" id="division-count" name="divisionCount" readonly aria-readonly="true"/>
        </div>
        <!-- Removed cash deposit input as requested -->
        <button type="submit" id="submit-btn">Simpan Data Pengantaran</button>
      </form>
    </section>

    <section class="search-section" aria-labelledby="search-header">
      <h2 id="search-header" style="font-size:1.25rem; margin-bottom:8px;">Data Pengantaran Hari Ini</h2>
      <div class="total-cash-container" id="totalCashContainer" aria-live="polite" aria-atomic="true" aria-relevant="text">
        Total Uang Cash Supir Terpilih: Rp <span id="totalCashDisplay">0</span>
      </div>
      <div class="results-section" id="results" aria-live="polite" aria-atomic="true" aria-relevant="additions"></div>
    </section>

    <section aria-labelledby="search-header">
      <h2 id="search-header" style="font-size:1.25rem; margin: "16px 0 8px 0;">Cari Data Pengantaran</h2>
      <form id="search-form" aria-describedby="search-desc" novalidate class="search-form">
        <input type="text" id="search-driver" placeholder="Cari berdasarkan Nama Supir" aria-label="Cari berdasarkan Nama Supir" autocomplete="off" />
        <input type="date" id="search-date" aria-label="Cari berdasarkan Tanggal Pengantaran" />
        <input type="text" id="search-route" placeholder="Cari berdasarkan Rute" aria-label="Cari berdasarkan Rute" autocomplete="off" />
        <button type="submit" class="search-button" aria-label="Mulai pencarian">Cari</button>
      </form>
    </section>

  </main>
<script>
  (() => {
    // Storage keys
    const DELIVERY_DATA_KEY = 'delivery_data';
    const DRIVER_PLATE_MAP_KEY = 'driver_plate_map';
    const DARK_MODE_KEY = 'dark_mode_enabled';

    // Elements
    const form = document.getElementById('delivery-form');
    const dateInput = document.getElementById('date-delivery');
    const dayInput = document.getElementById('day-delivery');
    const driverInput = document.getElementById('driver-name');
    const plateInput = document.getElementById('plate-number');
    const routeInput = document.getElementById('route');
    const divisionInput = document.getElementById('division');
    const divisionCountInput = document.getElementById('division-count');
    const submitBtn = document.getElementById('submit-btn');

    const searchForm = document.getElementById('search-form');
    const searchDriverInput = document.getElementById('search-driver');
    const searchDateInput = document.getElementById('search-date');
    const searchRouteInput = document.getElementById('search-route');
    const resultsContainer = document.getElementById('results');
    const totalCashDisplay = document.getElementById('totalCashDisplay');

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeIcon = document.getElementById('darkModeIcon');

    // Utility: day names in Indonesian
    const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', "Jumat", 'Sabtu'];

    // In-memory set of selected entry IDs for cash sum
    let selectedForSum = new Set();

    // Get today date string yyyy-mm-dd
    function getTodayISODate() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = ('0' + (d.getMonth() + 1)).slice(-2);
      const dd = ('0' + d.getDate()).slice(-2);
      return `${yyyy}-${mm}-${dd}`;
    }

    // Load and save data helpers
    function loadDeliveryData() {
      try {
        return JSON.parse(localStorage.getItem(DELIVERY_DATA_KEY)) || [];
      } catch {
        return [];
      }
    }
    function saveDeliveryData(data) {
      localStorage.setItem(DELIVERY_DATA_KEY, JSON.stringify(data));
    }
    function loadDriverPlateMap() {
      try {
        return JSON.parse(localStorage.getItem(DRIVER_PLATE_MAP_KEY)) || {};
      } catch {
        return {};
      }
    }
    function saveDriverPlateMap(map) {
      localStorage.setItem(DRIVER_PLATE_MAP_KEY, JSON.stringify(map));
    }

    // Day update
    dateInput.addEventListener('input', () => {
      if (dateInput.value) {
        const date = new Date(dateInput.value + 'T00:00:00');
        dayInput.value = dayNames[date.getDay()];
      } else {
        dayInput.value = '';
      }
    });

    // Plate auto-fill
    driverInput.addEventListener('change', () => {
      const driver = driverInput.value.trim();
      if (!driver) {
        plateInput.value = '';
        plateInput.disabled = false;
        return;
      }
      const map = loadDriverPlateMap();
      if (map[driver]) {
        plateInput.value = map[driver];
        plateInput.disabled = true;
      } else {
        plateInput.value = '';
        plateInput.disabled = false;
      }
    });

    // Plate manual change
    plateInput.addEventListener('change', () => {
      const driver = driverInput.value.trim();
      if (driver && plateInput.value.trim()) {
        const map = loadDriverPlateMap();
        map[driver] = plateInput.value.trim();
        saveDriverPlateMap(map);
        plateInput.disabled = true;
      }
    });

    // Auto update division count
    divisionInput.addEventListener('input', () => {
      const divisionsRaw = divisionInput.value;
      const divisions = divisionsRaw.split(',').map(d => d.trim()).filter(d => d.length > 0);
      divisionCountInput.value = divisions.length || '';
    });

    // On submit, validate and save new entry
    form.addEventListener('submit', e => {
      e.preventDefault();
      submitBtn.disabled = true;
      // Validate fields
      if (!dateInput.value) {
        alert('Tanggal pengantaran harus diisi.');
        submitBtn.disabled = false;
        return;
      }
      if (!driverInput.value.trim()) {
        alert('Nama supir harus diisi.');
        submitBtn.disabled = false;
        return;
      }
      if (!plateInput.value.trim()) {
        alert('Nomor plat mobil harus diisi.');
        submitBtn.disabled = false;
        return;
      }
      if (!routeInput.value.trim()) {
        alert('Rute harus diisi.');
        submitBtn.disabled = false;
        return;
      }
      if (!divisionInput.value.trim()) {
        alert('Divisi barang harus diisi.');
        submitBtn.disabled = false;
        return;
      }
      if (!divisionCountInput.value || parseInt(divisionCountInput.value) < 1) {
        alert('Jumlah divisi harus lebih dari nol.');
        submitBtn.disabled = false;
        return;
      }

      // Save driver-plate mapping if new
      const driver = driverInput.value.trim();
      const plate = plateInput.value.trim();
      if (driver && plate) {
        const map = loadDriverPlateMap();
        if (!map[driver]) {
          map[driver] = plate;
          saveDriverPlateMap(map);
          plateInput.disabled = true;
        }
      }

      // Compose entry
      const dateObj = new Date(dateInput.value + 'T00:00:00');
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth() + 1;
      const day = dateObj.getDate();
      const dayName = dayNames[dateObj.getDay()];
      const divisionsRaw = divisionInput.value;
      const divisions = divisionsRaw.split(',').map(d => d.trim()).filter(d => d.length > 0);

      const entry = {
        id: Date.now().toString(),
        day: dayName,
        date: day,
        month: month,
        year: year,
        driver,
        plate,
        route: routeInput.value.trim(),
        division: divisions,
        divisionCount: divisions.length,
        cashDeposit: 0, // no cash deposit at creation
        adminChecked: false
      };

      const data = loadDeliveryData();
      data.push(entry);
      saveDeliveryData(data);
      alert('Data pengantaran berhasil disimpan.');

      form.reset();
      dayInput.value = '';
      divisionCountInput.value = '';
      plateInput.disabled = false;
      submitBtn.disabled = false;
      // Clear selection for sum
      selectedForSum.clear();
      updateTotalCashSum();

      renderCurrentDayEntries();
    });

    // Update cash deposit value for entry
    function onUpdateCashDeposit(id, newValue) {
      const data = loadDeliveryData();
      const index = data.findIndex(e => e.id === id);
      if (index >= 0) {
        data[index].cashDeposit = newValue;
        saveDeliveryData(data);
        updateTotalCashSum();
      }
    }

    // Toggle verification checkbox handler
    function onToggleVerification(id, checked) {
      const data = loadDeliveryData();
      const index = data.findIndex(e => e.id === id);
      if (index >= 0) {
        data[index].adminChecked = checked;
        saveDeliveryData(data);
        renderCurrentDayEntries();
      }
    }

    // Handle selection checkbox for summing cash deposit
    function onToggleSelection(id, checked) {
      if (checked) {
        selectedForSum.add(id);
      } else {
        selectedForSum.delete(id);
      }
      updateTotalCashSum();
    }

    // Update total cash sum display based on selected entries
    function updateTotalCashSum() {
      const data = loadDeliveryData();
      let sum = 0;
      for (const id of selectedForSum) {
        const entry = data.find(e => e.id === id);
        if (entry && typeof entry.cashDeposit === 'number') {
          sum += entry.cashDeposit;
        }
      }
      totalCashDisplay.textContent = sum.toLocaleString('id-ID');
    }

    // Parse number from input string safely
    function parseNumber(value) {
      const n = Number(value);
      if (isNaN(n) || n < 0) return 0;
      return n;
    }

    function renderEntries(items) {
      resultsContainer.innerHTML = '';
      if (!items.length) {
        resultsContainer.innerHTML = '<p style="text-align:center; color:#666;">Tidak ditemukan data pengantaran.</p>';
        totalCashDisplay.textContent = '0';
        selectedForSum.clear();
        return;
      }
      for (const entry of items) {
        const item = document.createElement('div');
        item.className = 'result-item';
        const divisionStr = Array.isArray(entry.division) 
          ? entry.division.join(', ') 
          : (typeof entry.division === 'string' ? entry.division : '');

        // Determine if this entry is selected for summation
        const isSelected = selectedForSum.has(entry.id);

        item.innerHTML = `
          <div class="select-checkbox">
            <input type="checkbox" aria-label="Pilih supir ${entry.driver} untuk penjumlahan uang cash" data-id="${entry.id}" ${isSelected ? 'checked' : ''} />
          </div>
          <div class="result-left" tabindex="0">
            <strong><span class="select-checkbox" style="width:auto; margin-right:8px;"></span>${entry.driver}</strong>
            <div>Plat: ${entry.plate || '-'}</div>
            <div>Rute: ${entry.route}</div>
            <div>Divisi: ${divisionStr} (Jumlah: ${entry.divisionCount})</div>
            <div>Tanggal: ${entry.day}, ${('0'+entry.date).slice(-2)}/${('0'+entry.month).slice(-2)}/${entry.year}</div>
            <div>
              <label for="cashinput-${entry.id}" style="font-weight:600; user-select:none;">Uang Cash (Rp): </label>
              <input 
                type="number" 
                min="0" 
                step="1000" 
                id="cashinput-${entry.id}" 
                class="cash-deposit-input" 
                value="${entry.cashDeposit}" 
                aria-label="Ubah uang cash yang disetor untuk pengantaran oleh ${entry.driver}" 
                data-id="${entry.id}" />
            </div>
          </div>
          <div class="result-status" aria-label="Status verifikasi oleh admin" style="margin-top:12px; grid-column:2/4;">
            <label>
              <input type="checkbox" aria-checked="${entry.adminChecked}" data-id="${entry.id}" />
              <span class="material-icons" aria-hidden="true">${entry.adminChecked ? 'check_circle' : 'pending'}</span> Verifikasi Admin
            </label>
          </div>
        `;
        // Insert the selection checkbox inside the strong with driver name
        const strongEl = item.querySelector('.result-left strong');
        const selectCheckbox = item.querySelector('.select-checkbox input[type="checkbox"]');
        strongEl.prepend(selectCheckbox.parentElement);

        resultsContainer.appendChild(item);
      }

      // Attach event listeners:
      // Selection checkboxes for summation
      resultsContainer.querySelectorAll('.select-checkbox input[type=checkbox]').forEach(chk => {
        chk.addEventListener('change', e => {
          const id = e.target.getAttribute('data-id');
          const checked = e.target.checked;
          onToggleSelection(id, checked);
        });
      });
      // Verification checkboxes
      resultsContainer.querySelectorAll('.result-status input[type=checkbox]').forEach(chk => {
        chk.addEventListener('change', ev => {
          const id = ev.target.getAttribute('data-id');
          const checked = ev.target.checked;
          onToggleVerification(id, checked);
        });
      });
      // Cash deposit inputs
      resultsContainer.querySelectorAll('.cash-deposit-input').forEach(input => {
        input.addEventListener('change', ev => {
          const el = ev.target;
          const id = el.getAttribute('data-id');
          const val = parseNumber(el.value);
          el.value = val; // normalize
          onUpdateCashDeposit(id, val);
        });
        input.addEventListener('blur', ev => {
          const el = ev.target;
          const id = el.getAttribute('data-id');
          const val = parseNumber(el.value);
          el.value = val;
          onUpdateCashDeposit(id, val);
        });
      });

      // Update total cash sum after render to capture saved selections
      updateTotalCashSum();
    }

    // Render only today's entries for initial preview
    function renderCurrentDayEntries() {
      const allData = loadDeliveryData();
      const todayISO = getTodayISODate();
      const filtered = allData.filter(entry => {
        const entryDateISO = new Date(entry.year, entry.month - 1, entry.date).toISOString().slice(0,10);
        return entryDateISO === todayISO;
      });
      // Clear selection for sum for preview
      selectedForSum.clear();
      updateTotalCashSum();
      renderEntries(filtered);
    }

    // Search form handler (searches all data)
    searchForm.addEventListener('submit', e => {
      e.preventDefault();
      const allData = loadDeliveryData();

      const driverSearch = searchDriverInput.value.trim().toLowerCase();
      const dateSearch = searchDateInput.value;
      const routeSearch = searchRouteInput.value.trim().toLowerCase();

      const filtered = allData.filter(entry => {
        let driverMatch = true,
            dateMatch = true,
            routeMatch = true;
        if (driverSearch) {
          driverMatch = entry.driver.toLowerCase().includes(driverSearch);
        }
        if (dateSearch) {
          const entryDateISO = new Date(entry.year, entry.month-1, entry.date).toISOString().slice(0,10);
          dateMatch = entryDateISO === dateSearch;
        }
        if (routeSearch) {
          routeMatch = entry.route.toLowerCase().includes(routeSearch);
        }
        return driverMatch && dateMatch && routeMatch;
      });
      // Clear selection on new search to avoid confusion
      selectedForSum.clear();
      updateTotalCashSum();
      renderEntries(filtered);
    });

    // Dark mode toggle function
    function applyDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add('dark');
        darkModeIcon.textContent = 'light_mode';
      } else {
        document.body.classList.remove('dark');
        darkModeIcon.textContent = 'dark_mode';
      }
    }
    darkModeToggle.addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark');
      const newMode = !isDark;
      applyDarkMode(newMode);
      localStorage.setItem(DARK_MODE_KEY, newMode ? '1' : '0');
    });

    // Load dark mode preference on page load
    function loadDarkModePreference() {
      const val = localStorage.getItem(DARK_MODE_KEY);
      const isDark = val === '1';
      applyDarkMode(isDark);
    }

    // Initial setup: load demo data and render today's entries
    function loadDemoData() {
      const map = loadDriverPlateMap();
      if (Object.keys(map).length === 0) {
        const demoMap = {
          'Agus': 'B 1234 XYZ',
          'Budi': 'D 5678 ABC',
          'Citra': 'F 9012 DEF'
        };
        saveDriverPlateMap(demoMap);
      }
      const data = loadDeliveryData();
      if (data.length === 0) {
        const demoEntries = [
          {
            id: 'demo1',
            day: 'Senin',
            date: 14,
            month: 8,
            year: 2023,
            driver: 'Agus',
            plate: 'B 1234 XYZ',
            route: 'Jakarta - Bandung',
            division: ['Elektronik'],
            divisionCount: 1,
            cashDeposit: 2000000,
            adminChecked: true
          },
          {
            id: 'demo2',
            day: 'Selasa',
            date: 15,
            month: 8,
            year: 2023,
            driver: 'Budi',
            plate: 'D 5678 ABC',
            route: 'Bandung - Surabaya',
            division: ['Makanan', 'Minuman'],
            divisionCount: 2,
            cashDeposit: 3500000,
            adminChecked: false
          },
          {
            id: 'demo3',
            day: 'Rabu',
            date: 16,
            month: 8,
            year: 2023,
            driver: 'Citra',
            plate: 'F 9012 DEF',
            route: 'Surabaya - Malang',
            division: ['Pakaian', 'Aksesoris', 'Sepatu'],
            divisionCount: 3,
            cashDeposit: 1500000,
            adminChecked: true
          }
        ];
        saveDeliveryData(demoEntries);
      }
      renderCurrentDayEntries();
    }

    loadDarkModePreference();
    loadDemoData();

  })();
</script>
</body>
</html>

